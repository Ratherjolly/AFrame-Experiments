<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pool Test</title>
    <meta name="description" content="Pool - A-Frame">
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
	<script>
	  
		AFRAME.registerComponent('laser', {
		  schema: {
			speed: { default: 1 }
		  },

		  init: function () {
			var el = this.el;
			var geometry = 'primitive: box; height: 2; width: 0.1; depth: 0.1';
			var material = 'color: yellow';
			el.setAttribute('geometry', geometry);
			el.setAttribute('material', material);
		  },

		  tick: function () {
			var el = this.el;
			var position = el.getAttribute('position');
			position.y += this.data.speed;
			el.setAttribute('position', position);
		  }
		});
		AFRAME.registerComponent('spaceship', {
	  init: function () {
		var el = this.el;
		var geometry = 'primitive: box; height: 2; width: 2; depth: 2;';
		var material = 'color: #167341; roughness: 1.0; metalness: 0.2;';
		el.setAttribute('geometry', geometry);
		el.setAttribute('material', material);
		this.onKeyDown = this.onKeyDown.bind(this);
	  },

	  play: function () {
		this.attachKeyEventListeners();
	  },

	  pause: function () {
		this.removeKeyEventListeners();
	  },
		  onKeyDown: function (evt) {
    var el = this.el;
    var laserEl;
    var position;
    if (evt.keyCode !== 32) { return; }
    laserEl = el.sceneEl.components.pool.requestEntity();
    if (!laserEl) { return; }
    position = el.getAttribute('position');
    laserEl.setAttribute('position', position);
    laserEl.play();
    setTimeout(this.laserDestroyer(laserEl), 1000);
  },

  laserDestroyer: function (el) {
    var laserEl = el;
    var component = this;
    return function () {
      if (!laserEl.isPlaying) {
        setTimeout(component.laserDestroyer(laserEl), 1000);
        return;
      }
      this.el.sceneEl.components.pool.returnEntity(laserEl);
    }.bind(this);
  },

  attachKeyEventListeners: function () {
    window.addEventListener('keydown', this.onKeyDown);
  },

  removeKeyEventListeners: function () {
    window.removeEventListener('keydown', this.onKeyDown);
  }
});
	</script>
    <style>
      body { background-color: black; }
      .message {
        position: absolute;
        height: 200px;
        width: 600px;
        top: calc(50% - 100px);
        left: calc(50% - 200px);
        color: white;
        font-size: 18pt;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="message"><p>Left and right arrows to move and space bar to shoot</p><p>Used Pool Entities</p></div>
    <a-scene update-pool-message=".message" stats pool="mixin: laser; size: 10">
      <a-assets>
        <a-mixin id="laser" laser></a-mixin>
      </a-assets>
      <a-entity
        position="0 -10 -10"
        wasd-controls="acceleration: 400; wsEnabled: false"
        spaceship></a-entity>
      <a-entity position="0 0 20">
        <a-entity camera="fov: 45"></a-entity>
      </a-entity>
    </a-scene>
  </body>
  <script>
    var message = '<p>Left and right arrows to move and space bar to shoot</p><p>Used Pool Entities ';
    AFRAME.registerComponent('update-pool-message', {
      schema: {type: 'selector'},
      tick: function () {
        var poolComponent = this.el.components.pool;
        var poolSize = poolComponent.availableEls.length + poolComponent.usedEls.length;
        var usedPoolEntities = this.el.components.pool.usedEls.length;
        this.data.innerHTML = message + usedPoolEntities + '/' + poolSize + '</p>';
      }
    });
  </script>
</html>
